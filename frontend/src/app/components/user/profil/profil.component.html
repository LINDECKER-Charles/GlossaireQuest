<main class="page">
  <section aria-labelledby="profile-title" class="card max-w-lg w-full h-full m-8">
    <!-- Titre -->
    <h1 id="profile-title" class="section-title text-center">Profil utilisateur</h1>

    <!-- État : chargement -->
    <div *ngIf="loading" class="text-center text-muted animate-pulse">
      Chargement des informations...
    </div>

    <!-- État : erreur -->
    <div *ngIf="error" class="text-center text-red-500 font-semibold">
      {{ error }}
    </div>

    <!-- Informations utilisateur -->
    <dl *ngIf="!loading && user" class="profile-info">
      <div class="profile-row">
        <dt>Nom :</dt>
        <dd>{{ user.name }}</dd>
      </div>

      <div class="profile-row">
        <dt>Email :</dt>
        <dd>{{ user.email }}</dd>
      </div>

      <div class="profile-row">
        <dt>Rôle :</dt>
        <dd>{{ user.role }}</dd>
      </div>

      <div class="profile-row">
        <dt>Vérifié :</dt>
        <dd>
          <span
            [ngClass]="{
              'text-green-400 font-semibold': user.isVerified,
              'text-red-400 font-semibold': !user.isVerified
            }"
          >
            {{ user.isVerified ? 'Oui' : 'Non' }}
          </span>
        </dd>
      </div>
      
    </dl>

    <!-- Actions -->
    <div *ngIf="!loading && user" class="profile-actions">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a routerLink="/profil/password-change" class="btn-outline p-2">Changer le mot de passe</a>
        <a routerLink="/profil/email-change" class="btn-outline p-2">Changer d’adresse e-mail</a>
        <a routerLink="/profil/name-change" [ngClass]="!isVerified() ? 'btn-outline p-2' : 'btn-outline sm:col-span-2 p-2'">Changer de nom</a>
        <a routerLink="/check-email" class="btn-outline p-2" *ngIf="!isVerified()" >Vérifier l’adresse e-mail</a>
      </div>

      <a
        routerLink="/profil/delete-account"
        class="btn-outline danger mt-6 w-full sm:w-auto mx-auto block text-center p-2"
      >
        Supprimer le compte
      </a>
    </div>

    <!-- Résumé des tentatives -->
    <section *ngIf="!loading && tries?.length" class="mt-12 card">
      <h2 class="section-title mb-6 text-center">Résumé des tentatives</h2>

      <div class="grid sm:grid-cols-3 gap-6 text-center text-neutral-100">
        <div class="stat">
          <p class="text-muted text-sm">Total de tentatives</p>
          <p class="text-3xl font-bold">{{ triesSummary.total }}</p>
        </div>

        <div class="stat">
          <p class="text-muted text-sm">Meilleur score</p>
          <p class="text-3xl font-bold text-primary-400">{{ triesSummary.best }}</p>
        </div>

        <div class="stat">
          <p class="text-muted text-sm">Moyenne</p>
          <p class="text-3xl font-bold text-green-300">
            {{ triesSummary.average | number:'1.0-1' }}
          </p>
        </div>
      </div>
    </section>

    <!-- 5 dernières tentatives -->
    <section *ngIf="!loading && tries?.length" class="mt-10 card">
      <h2 class="section-title mb-6 text-center">Dernières tentatives</h2>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead class="bg-neutral-900 text-primary-400">
            <tr>
              <th class="py-3 px-4">Quiz</th>
              <th class="py-3 px-4 text-center">Résultat</th>
              <th class="py-3 px-4 text-center">Date</th>
            </tr>
          </thead>

          <tbody>
            <tr
              *ngFor="let t of tries | slice:0:5"
              class="border-t border-neutral-700 hover:bg-neutral-800/70 transition duration-200"
            >
              <td class="nav-link hover:nav-link-active hover:cursor-pointer" routerLink="/quizz/{{ t.quizId }}">{{ t.quizName }}</td>
              <td class="py-3 px-4 text-center text-primary-400 font-semibold">
                {{ t.result }} / {{t.maxPoint}}
                <span 
                [ngClass]="{
                  'text-green-500': (t.result / t.maxPoint) * 100 >= 70,
                  'text-yellow-500': (t.result / t.maxPoint) * 100 >= 40 && (t.result / t.maxPoint) * 100 < 70,
                  'text-red-500': (t.result / t.maxPoint) * 100 < 40}">
                  [{{ (t.result / t.maxPoint) * 100 | number:'1.0-1' }}%]
                </span>
              </td>
              <td class="py-3 px-4 text-center text-neutral-400">
                {{ t.date | date:'short' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button routerLink="/profil/history" class="btn-primary w-full py-2.5 mt-6 font-semibold">
        Historique complet
      </button>
    </section>

    <!-- Aucun essai -->
    <section
      *ngIf="!loading && (!tries?.length || tries?.length === 0)"
      class="mt-10 text-center text-muted"
    >
      Aucune tentative enregistrée pour le moment.
    </section>




    <!-- Bouton déconnexion -->
    <div *ngIf="!loading && user" class="text-center mt-8">
      <button (click)="logout()" class="btn-primary w-full py-2.5 font-semibold">
        Déconnexion
      </button>
    </div>
  </section>
</main>
